name: Create PR, Approve, and Merge

on:
    workflow_call:
        inputs:
            repository: 
              description: Target repository (e.g., "pattern-labs/maps")
              type: string
              required: true
            commit-message:
              description: Commit message for the changes
              type: string
              required: false
              default: Automated PR creation, approval, and merge commit.
            title:
              description: Pull request title
              type: string
              required: false
              default: Automated PR creation, approval, and merge
            add-paths:
              description: Files to add to the commit (space or newline separated)
              type: string
              required: false
              default: '.'
            body:
              description: Pull request body/description
              type: string
              required: false
              default: Automated PR created by reusable workflow
            branch:
              description: Branch name for the pull request
              type: string
              required: false
              default: automation/${{ github.run_id }}
            path:
              description: Working directory path
              type: string
              required: false
              default: '.'
            delete-branch:
              description: Whether to delete the branch after merge
              type: boolean
              required: false
              default: true
            merge-method:
              description: Merge method (squash, merge, or rebase)
              type: string
              required: false
              default: squash
        outputs:
            pull-request-number:
              description: 'The number of the created pull request'
              value: ${{ jobs.create-pr-approve-merge.outputs.pr-number }}
            pull-request-url:
                description: 'The URL of the created pull request'
                value: ${{ jobs.create-pr-approve-merge.outputs.pr-url }}

jobs:
    create-pr-approve-merge:
        name: Create PR, approve, and merge in ${{ inputs.repository }} repository
        runs-on: [ubuntu-latest]
        outputs:
            pr-number: ${{ steps.create-pr.outputs.pull-request-number }}
            pr-url: ${{ steps.create-pr.outputs.pull-request-url }}
        steps:
            - name: Setup .netrc
              uses: Pattern-Labs/.github/.github/actions/setup_netrc@main
              with:
               repo_access_pat: ${{ secrets.REPO_ACCESS_PAT }}
            - name: Create Pull Request
              id: create-pr
              uses: peter-evans/create-pull-request@v6
              with:
                token: ${{ secrets.REPO_ACCESS_PAT }}
                path: ${{ inputs.path }}
                commit-message: ${{ inputs.commit-message }}
                branch: ${{ inputs.branch }}
                title: ${{ inputs.title }}
                add-paths: ${{ inputs.add-paths }}
                body: ${{ inputs.body }}
                delete-branch: ${{ inputs.delete-branch }}
            - name: Approve Pull Request
              if: steps.create-pr.outputs.pull-request-number != ''
              shell: bash
              env:
                  GH_TOKEN: ${{ secrets.PATTERN_PR_APPROVER }}
              run: |
                  gh pr review \
                  --repo "${{ inputs.repository }}" \
                  "${{ steps.create-pr.outputs.pull-request-number }}" \
                  --approve
            - name: Merge Pull Request
              if: steps.create-pr.outputs.pull-request-number != ''
              shell: bash
              env:
                GH_TOKEN: ${{ secrets.REPO_ACCESS_PAT }}
              run: |
                gh pr merge \
                  --repo "${{ inputs.repository }}" \
                  "${{ steps.create-pr.outputs.pull-request-number }}" \
                  --${{ inputs.merge-method }} \
                  --auto
