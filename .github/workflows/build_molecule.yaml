name: Build Molecule

on:
  workflow_call:
    inputs:
      molecule_path:
        description: path to molecule to build
        required: true
        type: string
      tag:
        description: tag to tag built images with
        required: true
        type: string
      with_cloud_cache:
        description: whether to use the cloud cache
        required: false
        type: boolean
        default: false

jobs:
  build-molecule:
    name: Build ${{ inputs.molecule_path }}
    runs-on: [github-hosted-cloud-builder]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          lfs: true

      - name: Setup Cloud Deps
        uses: Pattern-Labs/.github/.github/actions/setup_cloud_deps@main
        with:
          repo_access_pat: ${{ secrets.REPO_ACCESS_PAT }}
          docker_user: ${{ secrets.DOCKER_USER }}
          docker_password: ${{ secrets.DOCKER_PASSWORD }}
          helm_user: ${{ secrets.HELM_USER }}
          helm_password: ${{ secrets.HELM_PASSWORD }}

      - name: Establish Google Cloud Auth
        id: "auth"
        uses: "google-github-actions/auth@v2"
        with:
          project_id: "stalwart-summer-374519"
          workload_identity_provider: "projects/515604670361/locations/global/workloadIdentityPools/github/providers/pattern"
          service_account: "github-runner@stalwart-summer-374519.iam.gserviceaccount.com"

      - name: Set Up Build Cache Credentials
        if: ${{ inputs.with_cloud_cache }}
        env:
          DATA: "${{ secrets.GOOGLE_CLOUD_BUILD_CACHE_ACCESS_KEY }}"
        run: echo $DATA > ./google-services.json

      - name: Setup Auth for Google Cloud Docker Cache
        uses: google-github-actions/auth@v0
        with:
          workload_identity_provider: projects/your-project-id/locations/global/workloadIdentityPools/your-identity-pool/providers/your-provider
          service_account: github-ci@your-project.iam.gserviceaccount.com

      - name: Cache Docker Images
        uses: mansagroup/gcs-cache-action@v2
        with:
          bucket: cloud_docker_cache
          path: /var/lib/docker/
          key: ${{ github.repository }}
          restore-keys: |
            ${{ github.repository }}

      # - name: Cache Docker images.
      # uses: ScribeMD/docker-cache@0.5.0
      # with:
      #   key: docker-${{ runner.os }}-${{ hashFiles(paths) }}

      - name: Build Molecule
        run: |
          cd ${{ inputs.molecule_path }}
          pattern molecule build -t ${{ inputs.tag }} --with_cloud_cache=${{ inputs.with_cloud_cache }}
